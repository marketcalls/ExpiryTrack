<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status - ExpiryTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body data-theme="light">
    <!-- Navbar -->
    <div class="navbar bg-base-200">
        <div class="flex-1">
            <a class="btn btn-ghost text-xl" href="/">ðŸ“ˆ ExpiryTrack</a>
        </div>
        <div class="flex-none">
            <ul class="menu menu-horizontal px-1">
                <li><a href="/">Home</a></li>
                <li><a href="/collect">ðŸ“Š Collect Data</a></li>
                <li class="font-bold"><a href="/status">ðŸ“ˆ Status</a></li>
                <li><a href="/settings">Settings</a></li>
                <li><a href="/logout" class="text-error">Logout</a></li>
            </ul>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6">System Status</h1>

        <!-- Database Statistics -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title">ðŸ“Š Database Statistics</h2>

                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">Instruments</div>
                        <div class="stat-value text-primary">{{ stats.total_instruments }}</div>
                    </div>

                    <div class="stat">
                        <div class="stat-title">Expiries</div>
                        <div class="stat-value text-secondary">{{ stats.total_expiries }}</div>
                    </div>

                    <div class="stat">
                        <div class="stat-title">Contracts</div>
                        <div class="stat-value text-accent">{{ "{:,}".format(stats.total_contracts) }}</div>
                    </div>

                    <div class="stat">
                        <div class="stat-title">Historical Candles</div>
                        <div class="stat-value">{{ "{:,}".format(stats.total_candles) }}</div>
                    </div>
                </div>

                <div class="stats shadow mt-4">
                    <div class="stat">
                        <div class="stat-title">Pending Expiries</div>
                        <div class="stat-value text-warning">{{ stats.pending_expiries }}</div>
                    </div>

                    <div class="stat">
                        <div class="stat-title">Pending Contracts</div>
                        <div class="stat-value text-warning">{{ stats.pending_contracts }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Collection Tasks -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">ðŸ•’ Recent Collection Tasks</h2>

                {% if tasks %}
                <div class="overflow-x-auto">
                    <table class="table w-full">
                        <thead>
                            <tr>
                                <th>Started</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Instruments</th>
                                <th>Stats</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td>
                                    {% if task.started_at %}
                                        {{ task.started_at[:19].replace('T', ' ') }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.status == 'completed' %}
                                        <div class="badge badge-success">Completed</div>
                                    {% elif task.status == 'running' %}
                                        <div class="badge badge-primary">Running</div>
                                    {% elif task.status == 'failed' %}
                                        <div class="badge badge-error">Failed</div>
                                    {% else %}
                                        <div class="badge">{{ task.status }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <progress class="progress progress-primary w-20" value="{{ task.progress }}" max="100"></progress>
                                    {{ task.progress }}%
                                </td>
                                <td>
                                    {% if task.params and task.params.instruments %}
                                        {{ task.params.instruments|join(', ') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="text-xs">
                                        C: {{ task.stats.contracts }}<br>
                                        D: {{ "{:,}".format(task.stats.candles) }}<br>
                                        E: {{ task.stats.errors }}
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-xs" onclick="viewTaskDetails('{{ task.task_id }}')">View</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>No collection tasks yet. <a href="/collect" class="link">Start collecting data</a></span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for task details -->
    <dialog id="task_modal" class="modal">
        <div class="modal-box w-11/12 max-w-5xl">
            <h3 class="font-bold text-lg">Task Details</h3>
            <div id="task_details" class="py-4">
                <div class="loading loading-spinner loading-lg"></div>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Close</button>
                </form>
            </div>
        </div>
    </dialog>

    <script>
        async function viewTaskDetails(taskId) {
            const modal = document.getElementById('task_modal');
            const detailsDiv = document.getElementById('task_details');

            modal.showModal();
            detailsDiv.innerHTML = '<div class="loading loading-spinner loading-lg"></div>';

            try {
                const response = await fetch(`/api/collect/status/${taskId}`);
                const task = await response.json();

                let html = '<div class="space-y-2">';
                html += `<p><strong>Task ID:</strong> ${task.task_id}</p>`;
                html += `<p><strong>Status:</strong> <span class="badge">${task.status}</span></p>`;
                html += `<p><strong>Progress:</strong> ${task.progress}%</p>`;
                html += `<p><strong>Current Action:</strong> ${task.current_action}</p>`;

                if (task.error_message) {
                    html += `<div class="alert alert-error"><span>${task.error_message}</span></div>`;
                }

                // Show logs
                if (task.logs && task.logs.length > 0) {
                    html += '<h4 class="font-bold mt-4">Recent Logs:</h4>';
                    html += '<div class="bg-base-200 p-2 rounded max-h-60 overflow-y-auto text-xs font-mono">';
                    task.logs.slice(-20).forEach(log => {
                        const levelClass = log.level === 'error' ? 'text-error' :
                                         log.level === 'warning' ? 'text-warning' :
                                         log.level === 'success' ? 'text-success' : '';
                        html += `<div class="${levelClass}">[${log.timestamp.split('T')[1].slice(0,8)}] ${log.message}</div>`;
                    });
                    html += '</div>';
                }

                html += '</div>';
                detailsDiv.innerHTML = html;
            } catch (error) {
                detailsDiv.innerHTML = `<div class="alert alert-error">Failed to load task details: ${error.message}</div>`;
            }
        }

        // Auto-refresh if there are running tasks
        {% if tasks %}
        const hasRunningTasks = {{ tasks|selectattr('status', 'equalto', 'running')|list|length }} > 0;
        if (hasRunningTasks) {
            setTimeout(() => location.reload(), 5000); // Refresh every 5 seconds
        }
        {% endif %}
    </script>
</body>
</html>