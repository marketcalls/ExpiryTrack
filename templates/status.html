{% extends "base.html" %}

{% block title %}Status - ExpiryTrack{% endblock %}

{% block breadcrumbs %}<li class="text-gray-700 font-medium">Status</li>{% endblock %}

{% block content %}
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 supabase-text-gradient">System Status</h1>

        <!-- Database Statistics -->
        <div class="card-minimal mb-8">
            <div class="p-8">
                <h2 class="text-2xl font-semibold mb-6">Database Statistics</h2>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-800 mb-2">{{ stats.total_instruments }}</div>
                        <div class="text-sm text-gray-600 font-medium">Instruments</div>
                    </div>

                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-800 mb-2">{{ stats.total_expiries }}</div>
                        <div class="text-sm text-gray-600 font-medium">Expiries</div>
                    </div>

                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-800 mb-2">{{ "{:,}".format(stats.total_contracts) }}</div>
                        <div class="text-sm text-gray-600 font-medium">Contracts</div>
                    </div>

                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-800 mb-2">{{ "{:,}".format(stats.total_candles) }}</div>
                        <div class="text-sm text-gray-600 font-medium">Historical Candles</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 pt-6 border-t border-gray-200">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-600 mb-2">{{ stats.pending_expiries }}</div>
                        <div class="text-sm text-gray-600 font-medium">Pending Expiries</div>
                    </div>

                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-600 mb-2">{{ stats.pending_contracts }}</div>
                        <div class="text-sm text-gray-600 font-medium">Pending Contracts</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduler -->
        <div class="card-minimal mb-8">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold">Scheduler</h2>
                    <div id="scheduler-controls" class="flex items-center gap-3">
                        <span id="scheduler-badge" class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Loading...</span>
                        <button id="scheduler-toggle" onclick="toggleScheduler()" class="text-sm px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-100">...</button>
                    </div>
                </div>

                <div id="scheduler-jobs" class="space-y-2 text-sm text-gray-600">
                    <div class="text-center text-gray-400">Loading scheduler status...</div>
                </div>

                <div id="scheduler-history" class="mt-4 hidden">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent History</h4>
                    <div id="scheduler-history-list" class="text-xs font-mono space-y-1 max-h-32 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Recent Collection Tasks -->
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-2xl font-semibold mb-6">Recent Collection Tasks</h2>

                {% if tasks %}
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Started</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Progress</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Instruments</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Stats</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr class="border-b border-gray-100">
                                <td class="py-3 px-4 text-sm text-gray-600">
                                    {% if task.started_at %}
                                        {{ task.started_at[:19].replace('T', ' ') }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </td>
                                <td class="py-3 px-4">
                                    {% if task.status == 'completed' %}
                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Completed</span>
                                    {% elif task.status == 'running' %}
                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Running</span>
                                    {% elif task.status == 'failed' %}
                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Failed</span>
                                    {% else %}
                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">{{ task.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="py-3 px-4">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-20 bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" style="width: {{ task.progress }}%"></div>
                                        </div>
                                        <span class="text-sm text-gray-600">{{ task.progress }}%</span>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-600">
                                    {% if task.params and task.params.instruments %}
                                        {{ task.params.instruments|join(', ') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="py-3 px-4">
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div>C: {{ task.stats.contracts }}</div>
                                        <div>D: {{ "{:,}".format(task.stats.candles) }}</div>
                                        <div>E: {{ task.stats.errors }}</div>
                                    </div>
                                </td>
                                <td class="py-3 px-4">
                                    <button onclick="viewTaskDetails('{{ task.task_id }}')" class="text-sm text-green-600 hover:text-green-800 font-medium">View</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="card-minimal p-4 border-blue-200 bg-blue-50">
                    <span class="text-blue-800 text-sm">No collection tasks yet. <a href="/collect" class="underline hover:text-blue-900">Start collecting data</a></span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for task details -->
    <div id="task_modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="card-minimal w-11/12 max-w-5xl max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Task Details</h3>
                    <button onclick="closeTaskModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
                </div>
                <div id="task_details" class="py-4">
                    <div class="text-center text-gray-500">Loading...</div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    async function viewTaskDetails(taskId) {
        const modal = document.getElementById('task_modal');
        const detailsDiv = document.getElementById('task_details');

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        detailsDiv.innerHTML = '<div class="text-center text-gray-500">Loading...</div>';

        try {
            const response = await fetch(`/api/collect/status/${taskId}`);
            const task = await response.json();

            let html = '<div class="space-y-4">';
            html += `<div class="grid grid-cols-2 gap-4 text-sm">`;
            html += `<div><strong class="text-gray-700">Task ID:</strong> <span class="text-gray-600">${task.task_id}</span></div>`;
            html += `<div><strong class="text-gray-700">Status:</strong> <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">${task.status}</span></div>`;
            html += `<div><strong class="text-gray-700">Progress:</strong> <span class="text-gray-600">${task.progress}%</span></div>`;
            html += `<div><strong class="text-gray-700">Current Action:</strong> <span class="text-gray-600">${task.current_action}</span></div>`;
            html += `</div>`;

            if (task.error_message) {
                html += `<div class="card-minimal p-3 border-red-200 bg-red-50"><span class="text-red-800 text-sm">${task.error_message}</span></div>`;
            }

            // Show logs
            if (task.logs && task.logs.length > 0) {
                html += '<h4 class="font-semibold text-gray-800 mt-6 mb-3">Recent Logs:</h4>';
                html += '<div class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto text-xs font-mono border">';
                task.logs.slice(-20).forEach(log => {
                    const levelClass = log.level === 'error' ? 'text-red-600' :
                                     log.level === 'warning' ? 'text-yellow-600' :
                                     log.level === 'success' ? 'text-green-600' : 'text-gray-600';
                    html += `<div class="${levelClass} mb-1">[${log.timestamp.split('T')[1].slice(0,8)}] ${log.message}</div>`;
                });
                html += '</div>';
            }

            html += '</div>';
            detailsDiv.innerHTML = html;
        } catch (error) {
            detailsDiv.innerHTML = `<div class="card-minimal p-3 border-red-200 bg-red-50"><span class="text-red-800 text-sm">Failed to load task details: ${error.message}</span></div>`;
        }
    }

    function closeTaskModal() {
        const modal = document.getElementById('task_modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Close modal when clicking outside
    document.getElementById('task_modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeTaskModal();
        }
    });

    // Auto-refresh if there are running tasks
    {% if tasks %}
    const hasRunningTasks = {{ tasks|selectattr('status', 'equalto', 'running')|list|length }} > 0;
    if (hasRunningTasks) {
        setTimeout(() => location.reload(), 5000);
    }
    {% endif %}

    // ── Scheduler UI ──
    let schedulerRunning = false;

    async function loadSchedulerStatus() {
        try {
            const res = await fetch('/api/scheduler/status');
            const data = await res.json();
            schedulerRunning = data.running;

            // Badge
            const badge = document.getElementById('scheduler-badge');
            if (data.running) {
                badge.textContent = 'Running';
                badge.className = 'inline-flex px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800';
            } else {
                badge.textContent = data.enabled ? 'Stopped' : 'Disabled';
                badge.className = 'inline-flex px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800';
            }

            // Toggle button
            const btn = document.getElementById('scheduler-toggle');
            btn.textContent = data.running ? 'Stop' : 'Start';

            // Jobs
            const jobsDiv = document.getElementById('scheduler-jobs');
            if (data.jobs && data.jobs.length > 0) {
                jobsDiv.innerHTML = data.jobs.map(job => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <div>
                            <span class="font-medium text-gray-800">${job.name}</span>
                            <span class="ml-2 text-xs text-gray-500">${job.trigger}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">${job.next_run ? 'Next: ' + new Date(job.next_run).toLocaleString() : 'Paused'}</span>
                            <button onclick="toggleJob('${job.id}', ${!job.paused})" class="text-xs px-2 py-0.5 rounded border ${job.paused ? 'border-green-300 text-green-600' : 'border-yellow-300 text-yellow-600'}">${job.paused ? 'Resume' : 'Pause'}</button>
                        </div>
                    </div>
                `).join('');
            } else {
                jobsDiv.innerHTML = '<div class="text-center text-gray-400">No scheduled jobs</div>';
            }

            // History
            if (data.recent_history && data.recent_history.length > 0) {
                document.getElementById('scheduler-history').classList.remove('hidden');
                document.getElementById('scheduler-history-list').innerHTML = data.recent_history.map(h => {
                    const color = h.status === 'success' ? 'text-green-600' : h.status === 'error' ? 'text-red-600' : 'text-yellow-600';
                    return `<div class="${color}">[${h.timestamp.split('T')[1]?.slice(0,8) || ''}] ${h.job_id}: ${h.status}${h.error ? ' - ' + h.error : ''}</div>`;
                }).join('');
            }
        } catch (e) {
            console.error('Failed to load scheduler status:', e);
        }
    }

    async function toggleScheduler() {
        const action = schedulerRunning ? 'stop' : 'start';
        await fetch('/api/scheduler/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action})
        });
        loadSchedulerStatus();
    }

    async function toggleJob(jobId, pause) {
        const endpoint = pause ? 'pause' : 'resume';
        await fetch(`/api/scheduler/jobs/${jobId}/${endpoint}`, {method: 'POST'});
        loadSchedulerStatus();
    }

    // Load scheduler status on page load
    loadSchedulerStatus();
</script>
{% endblock %}