{% extends "base.html" %}

{% block title %}Data Collection Wizard - ExpiryTrack{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">Data Collection Wizard</h1>
        <p class="text-gray-600">Collect historical data for expired Futures and Options contracts</p>
    </div>

    <!-- Steps Progress -->
    <div class="mb-8">
        <div class="flex items-center justify-center space-x-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                <span class="ml-2 text-sm font-medium text-gray-700">Select Instruments</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Contract Types</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Expiry Dates</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold">4</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Configure & Download</span>
            </div>
        </div>
    </div>

    <!-- Step 1: Select Instruments -->
    <div id="step1" class="step-content">
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-xl font-semibold mb-6">Step 1: Select Instruments</h2>
                <p class="text-gray-600 mb-6">Choose the instruments you want to collect expired contract data for:</p>

                <div id="instruments-container" class="space-y-4">
                    <div class="text-center text-gray-400 py-4">Loading instruments...</div>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg" onclick="selectAll()">
                        Select All
                    </button>
                    <button type="button" class="btn-supabase" onclick="nextStep(1)" id="next1" disabled>
                        Next Step
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Contract Types -->
    <div id="step2" class="step-content hidden">
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-xl font-semibold mb-6">Step 2: Select Contract Types</h2>
                <p class="text-gray-600 mb-6">Choose the type of contracts to download:</p>

                <div class="space-y-4">
                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                        <input type="radio" id="options" name="contract_type" value="options" class="mr-4">
                        <label for="options" class="cursor-pointer flex-1">
                            <div class="font-medium text-gray-900">Options Only</div>
                            <div class="text-sm text-gray-600">Call and Put options for all strikes</div>
                        </label>
                    </div>

                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                        <input type="radio" id="futures" name="contract_type" value="futures" class="mr-4">
                        <label for="futures" class="cursor-pointer flex-1">
                            <div class="font-medium text-gray-900">Futures Only</div>
                            <div class="text-sm text-gray-600">Futures contracts</div>
                        </label>
                    </div>

                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                        <input type="radio" id="both" name="contract_type" value="both" class="mr-4" checked>
                        <label for="both" class="cursor-pointer flex-1">
                            <div class="font-medium text-gray-900">Both Options & Futures</div>
                            <div class="text-sm text-gray-600">All available contracts (recommended)</div>
                        </label>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg" onclick="prevStep(2)">
                        Previous
                    </button>
                    <button type="button" class="btn-supabase" onclick="nextStep(2)">
                        Next Step
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Expiry Dates -->
    <div id="step3" class="step-content hidden">
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-xl font-semibold mb-6">Step 3: Select Expiry Dates</h2>
                <p class="text-gray-600 mb-6">Choose which expiry dates to collect data for:</p>

                <div id="expiry-container" class="space-y-6">
                    <!-- Expiry dates will be loaded here -->
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg" onclick="prevStep(3)">
                        Previous
                    </button>
                    <button type="button" class="btn-supabase" onclick="nextStep(3)" id="next3" disabled>
                        Next Step
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Configure & Download -->
    <div id="step4" class="step-content hidden">
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-xl font-semibold mb-6">Step 4: Configure & Download</h2>

                <!-- Summary -->
                <div class="card-minimal p-4 mb-6 border-blue-200 bg-blue-50">
                    <h3 class="font-semibold text-blue-800 mb-2">Summary</h3>
                    <div id="collection-summary" class="text-sm text-blue-700">
                        <!-- Summary will be populated -->
                    </div>
                </div>

                <!-- Configuration -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Interval</label>
                        <select id="interval" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <option value="1minute">1 Minute (Recommended)</option>
                            <option value="5minute">5 Minutes</option>
                            <option value="15minute">15 Minutes</option>
                            <option value="30minute">30 Minutes</option>
                            <option value="1hour">1 Hour</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Concurrent Workers</label>
                        <input type="range" id="workers" min="1" max="10" value="5"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1 (Slow)</span>
                            <span id="workers-value">5 (Balanced)</span>
                            <span>10 (Fast)</span>
                        </div>
                    </div>
                </div>

                <!-- Inline Progress Section -->
                <div id="inline-progress" class="hidden mt-8">
                    <div class="card-minimal p-6 border-green-200 bg-green-50">
                        <h3 class="text-xl font-semibold mb-6 text-green-800">Data Collection in Progress</h3>

                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                            <div id="progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="text-center">
                                <div id="stat-expiries" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Expiries</div>
                            </div>
                            <div class="text-center">
                                <div id="stat-contracts" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Contracts</div>
                            </div>
                            <div class="text-center">
                                <div id="stat-candles" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Candles</div>
                            </div>
                            <div class="text-center">
                                <div id="stat-errors" class="text-2xl font-bold text-red-600">0</div>
                                <div class="text-sm text-gray-600">Errors</div>
                            </div>
                        </div>

                        <!-- Per-Instrument Progress -->
                        <div id="instrument-progress-section" class="mb-4 hidden">
                            <div class="text-sm text-gray-600 mb-2">Per-Instrument Progress:</div>
                            <div id="instrument-progress-bars" class="space-y-2"></div>
                        </div>

                        <!-- Current Action -->
                        <div class="mb-4">
                            <div class="text-sm text-gray-600 mb-1">Current Action:</div>
                            <div id="current-action" class="font-medium text-gray-800">Initializing...</div>
                        </div>

                        <!-- Completion Actions -->
                        <div id="completion-actions" class="hidden mt-4 text-center">
                            <button onclick="window.location.href='{{ url_for('status_page') }}'" class="btn-supabase mr-4">
                                View Status
                            </button>
                            <button onclick="startNewCollection()" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg">
                                Start New Collection
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" id="prev-button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg" onclick="prevStep(4)">
                        Previous
                    </button>
                    <button type="button" id="start-button" class="btn-supabase text-lg px-8 py-3" onclick="startCollection()">
                        Start Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="card-minimal max-w-2xl w-full mx-4">
            <div class="p-8">
                <h3 class="text-xl font-semibold mb-6">Data Collection in Progress</h3>

                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                    <div id="progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="stat-expiries">0</div>
                        <div class="text-xs text-gray-600">Expiries</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="stat-contracts">0</div>
                        <div class="text-xs text-gray-600">Contracts</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="stat-candles">0</div>
                        <div class="text-xs text-gray-600">Candles</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="stat-errors">0</div>
                        <div class="text-xs text-gray-600">Errors</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Wizard State
let currentStep = 1;
let selectedInstruments = [];
let selectedContractType = 'both';
let selectedExpiries = {};
let taskId = null;
let progressInterval = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadInstrumentsForWizard();
    setupWorkerSlider();
});

// Load instruments from API (#9)
async function loadInstrumentsForWizard() {
    try {
        const res = await fetch('/api/instruments');
        const data = await res.json();
        const container = document.getElementById('instruments-container');
        const instruments = (data.instruments || []).filter(i => i.is_active);
        if (instruments.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 py-4">No active instruments. Add some in Settings.</div>';
            return;
        }
        container.innerHTML = instruments.map((inst, idx) => `
            <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                <input type="checkbox" id="inst_${idx}" name="instruments" value="${inst.instrument_key}" class="mr-4">
                <label for="inst_${idx}" class="cursor-pointer flex-1">
                    <div class="font-medium text-gray-900">${inst.symbol}</div>
                    <div class="text-sm text-gray-600">${inst.instrument_key}</div>
                </label>
            </div>
        `).join('');
        updateInstrumentSelection();
    } catch (e) {
        document.getElementById('instruments-container').innerHTML =
            '<div class="text-red-500 text-center py-4">Failed to load instruments</div>';
    }
}

// Step Navigation
function nextStep(step) {
    if (step === 1 && selectedInstruments.length === 0) {
        showToast('Please select at least one instrument', 'warning');
        return;
    }

    if (step === 3 && Object.keys(selectedExpiries).length === 0) {
        showToast('Please select at least one expiry date', 'warning');
        return;
    }

    if (step === 2) {
        loadExpiries();
    } else if (step === 3) {
        showSummary();
    }

    hideStep(currentStep);
    currentStep = step + 1;
    showStep(currentStep);
    updateStepIndicator();
}

function prevStep(step) {
    hideStep(currentStep);
    currentStep = step - 1;
    showStep(currentStep);
    updateStepIndicator();
}

function showStep(step) {
    document.getElementById(`step${step}`).classList.remove('hidden');
}

function hideStep(step) {
    document.getElementById(`step${step}`).classList.add('hidden');
}

function updateStepIndicator() {
    // Update progress indicators
    for (let i = 1; i <= 4; i++) {
        const circle = document.querySelector(`.step-content:nth-child(${i + 2}) .w-8.h-8`);
        if (i <= currentStep) {
            circle?.classList.add('bg-green-500', 'text-white');
            circle?.classList.remove('bg-gray-300', 'text-gray-600');
        }
    }
}

// Instrument Selection
function selectAll() {
    const checkboxes = document.querySelectorAll('input[name="instruments"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });

    updateInstrumentSelection();
}

function updateInstrumentSelection() {
    const checkboxes = document.querySelectorAll('input[name="instruments"]:checked');
    selectedInstruments = Array.from(checkboxes).map(cb => cb.value);

    const nextBtn = document.getElementById('next1');
    nextBtn.disabled = selectedInstruments.length === 0;
    nextBtn.classList.toggle('opacity-50', selectedInstruments.length === 0);
}

// Load Expiries
async function loadExpiries() {
    const container = document.getElementById('expiry-container');
    container.innerHTML = '<div class="text-center text-gray-500">Loading expiries...</div>';

    try {
        const response = await fetch('/api/instruments/expiries', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ instruments: selectedInstruments })
        });

        const data = await response.json();
        displayExpiries(data.expiries);
    } catch (error) {
        container.innerHTML = '<div class="text-center text-red-500">Error loading expiries</div>';
    }
}

function displayExpiries(expiries) {
    const container = document.getElementById('expiry-container');
    container.innerHTML = '';

    Object.entries(expiries).forEach(([instrument, dates]) => {
        const instrumentDiv = document.createElement('div');
        instrumentDiv.className = 'border border-gray-200 rounded-lg p-4';

        const instrumentName = instrument.split('|')[1] || instrument;

        instrumentDiv.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <h4 class="font-medium text-gray-900">${instrumentName}</h4>
                <button type="button" class="text-sm text-green-600 hover:text-green-700" onclick="selectAllExpiries('${instrument}')">
                    Select All (${dates.length})
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                ${dates.map(date => `
                    <label class="flex items-center p-2 border border-gray-200 rounded cursor-pointer hover:border-green-300">
                        <input type="checkbox" name="expiry_${instrument}" value="${date}" class="mr-2" onchange="updateExpirySelection()">
                        <span class="text-sm">${formatDate(date)}</span>
                    </label>
                `).join('')}
            </div>
        `;

        container.appendChild(instrumentDiv);
    });
}

function selectAllExpiries(instrument) {
    const checkboxes = document.querySelectorAll(`input[name="expiry_${instrument}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });

    updateExpirySelection();
}

function updateExpirySelection() {
    selectedExpiries = {};

    selectedInstruments.forEach(instrument => {
        const checkboxes = document.querySelectorAll(`input[name="expiry_${instrument}"]:checked`);
        const dates = Array.from(checkboxes).map(cb => cb.value);
        if (dates.length > 0) {
            selectedExpiries[instrument] = dates;
        }
    });

    const nextBtn = document.getElementById('next3');
    nextBtn.disabled = Object.keys(selectedExpiries).length === 0;
    nextBtn.classList.toggle('opacity-50', Object.keys(selectedExpiries).length === 0);
}

// Show Summary
function showSummary() {
    selectedContractType = document.querySelector('input[name="contract_type"]:checked').value;

    let summary = `
        <p><strong>Instruments:</strong> ${selectedInstruments.map(i => i.split('|')[1] || i).join(', ')}</p>
        <p><strong>Contract Type:</strong> ${selectedContractType}</p>
        <p><strong>Expiries:</strong> ${Object.values(selectedExpiries).flat().length} selected</p>
    `;

    document.getElementById('collection-summary').innerHTML = summary;
}

// Worker Slider
function setupWorkerSlider() {
    const slider = document.getElementById('workers');
    const valueSpan = document.getElementById('workers-value');

    slider.addEventListener('input', function() {
        const value = parseInt(this.value);
        let description;

        if (value <= 3) description = `${value} (Conservative)`;
        else if (value <= 7) description = `${value} (Balanced)`;
        else description = `${value} (Aggressive)`;

        valueSpan.textContent = description;
    });
}

// Start Collection
async function startCollection() {
    // Check token status before starting (#7)
    try {
        const tokenRes = await fetch('/api/auth/token-status');
        const tokenData = await tokenRes.json();
        if (tokenData.valid && tokenData.remaining_seconds < 3600) {
            var mins = Math.floor(tokenData.remaining_seconds / 60);
            if (!confirm(`Token expires in ${mins} minutes. Collection may fail if token expires mid-way. Continue anyway?`)) return;
        }
    } catch (e) { /* ignore check failure, proceed */ }

    const interval = document.getElementById('interval').value;
    const workers = parseInt(document.getElementById('workers').value);

    const config = {
        instruments: selectedInstruments,
        contract_type: selectedContractType,
        expiries: selectedExpiries,
        interval: interval,
        workers: workers
    };

    try {
        const response = await fetch('/api/collect/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });

        const data = await response.json();

        if (data.success) {
            taskId = data.task_id;
            showInlineProgress();
            startProgressTracking();
        } else {
            showToast('Failed to start collection: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error starting collection: ' + error.message, 'error');
    }
}

// Progress Tracking
function showInlineProgress() {
    // Hide the start button and show the inline progress
    document.getElementById('start-button').style.display = 'none';
    document.getElementById('prev-button').style.display = 'none';
    document.getElementById('inline-progress').classList.remove('hidden');
}

function startProgressTracking() {
    progressInterval = setInterval(updateProgress, 1000);
}

async function updateProgress() {
    if (!taskId) return;

    try {
        const response = await fetch(`/api/collect/status/${taskId}`);
        const data = await response.json();

        // Handle task not found (404) - server was likely restarted
        if (response.status === 404 || data.error) {
            clearInterval(progressInterval);
            document.getElementById('current-action').textContent = 'Task not found - server may have restarted. Please start a new collection.';
            document.getElementById('current-action').className = 'font-medium text-orange-600';
            document.getElementById('completion-actions').classList.remove('hidden');
            return;
        }

        if (data.task_id || data.status) {
            const task = data;

            // Update progress bar
            document.getElementById('progress-bar').style.width = `${task.progress}%`;

            // Update stats
            document.getElementById('stat-expiries').textContent = task.stats.expiries || 0;
            document.getElementById('stat-contracts').textContent = task.stats.contracts || 0;
            document.getElementById('stat-candles').textContent = task.stats.candles || 0;
            document.getElementById('stat-errors').textContent = task.stats.errors || 0;

            // Update current action
            if (task.current_action) {
                document.getElementById('current-action').textContent = task.current_action;
            }

            // Render per-instrument progress
            if (task.instrument_progress && Object.keys(task.instrument_progress).length > 0) {
                const section = document.getElementById('instrument-progress-section');
                section.classList.remove('hidden');
                const container = document.getElementById('instrument-progress-bars');
                container.innerHTML = Object.entries(task.instrument_progress).map(([name, ip]) => {
                    const label = name.split('|')[1] || name;
                    const statusColor = ip.status === 'completed' ? 'green' :
                                        ip.status === 'failed' ? 'red' :
                                        ip.status === 'running' ? 'blue' : 'gray';
                    return `
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-medium w-28 truncate">${label}</span>
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div class="bg-${statusColor}-500 h-2 rounded-full transition-all duration-300" style="width:${ip.progress || 0}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 w-24 text-right">${ip.expiries_done || 0}/${ip.expiries_total || 0} expiries</span>
                        </div>
                    `;
                }).join('');
            }

            // Check if completed
            if (task.status === 'completed' || task.status === 'failed') {
                clearInterval(progressInterval);
                document.getElementById('completion-actions').classList.remove('hidden');

                if (task.status === 'completed') {
                    document.getElementById('current-action').textContent = 'Collection completed successfully!';
                    document.getElementById('current-action').className = 'font-medium text-green-600';
                } else {
                    document.getElementById('current-action').textContent = `Collection failed: ${task.error_message}`;
                    document.getElementById('current-action').className = 'font-medium text-red-600';
                }
            }
        }
    } catch (error) {
        console.error('Error updating progress:', error);
    }
}

// Log functions removed - not needed

function startNewCollection() {
    // Hide inline progress
    document.getElementById('inline-progress').classList.add('hidden');

    // Show buttons again
    document.getElementById('start-button').style.display = '';
    document.getElementById('prev-button').style.display = '';

    // Reset form to step 1
    showStep(1);

    // Clear all form data
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

    // Reset contract type to default (both)
    document.getElementById('both').checked = true;

    // Reset interval to default
    document.getElementById('interval').value = '1minute';

    // Reset workers to default
    document.getElementById('workers').value = '5';

    // Reset UI
    document.getElementById('step-2-content').innerHTML = '';
    document.getElementById('step-3-content').innerHTML = '';
    updateButtonStates();

    if (progressInterval) {
        clearInterval(progressInterval);
    }
}

function goToStatus() {
    window.location.href = '{{ url_for("status_page") }}';
}

// Utility Functions
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: '2-digit'
    });
}

// Event Listeners
document.addEventListener('change', function(e) {
    if (e.target.name === 'instruments') {
        updateInstrumentSelection();
    }
});
</script>
{% endblock %}