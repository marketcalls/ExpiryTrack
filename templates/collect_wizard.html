{% extends "base.html" %}

{% block title %}Data Collection Wizard - ExpiryTrack{% endblock %}

{% block breadcrumbs %}<li class="text-gray-700 font-medium">Collect Data</li>{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">Data Collection Wizard</h1>
        <p class="text-gray-600">Collect historical data for expired Futures and Options contracts</p>
    </div>

    <!-- Steps Progress -->
    <div class="mb-8">
        <div class="flex items-center justify-center space-x-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                <span class="ml-2 text-sm font-medium text-gray-700">Select Instruments</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Contract Types</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Expiry Dates</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold">4</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Configure & Download</span>
            </div>
        </div>
    </div>

    <!-- Step 1: Select Instruments -->
    <div id="step1" class="step-content">
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-xl font-semibold mb-4">Step 1: Select Instruments</h2>
                <p class="text-gray-600 mb-4">Choose the instruments you want to collect expired contract data for:</p>

                <!-- Search Filter -->
                <div class="mb-4">
                    <input type="text" id="instrument-search" placeholder="Search instruments..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                           oninput="filterInstruments()" />
                </div>

                <div id="instruments-container" class="space-y-4">
                    <div class="text-center text-gray-400 py-4">Loading instruments...</div>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <div class="flex gap-2">
                        <button type="button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg text-sm" onclick="selectAll()">
                            Select All
                        </button>
                        <button type="button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg text-sm" onclick="deselectAll()">
                            Deselect All
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="selection-count" class="text-sm text-gray-500"></span>
                        <button type="button" class="btn-supabase" onclick="nextStep(1)" id="next1" disabled>
                            Next Step
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Contract Types -->
    <div id="step2" class="step-content hidden">
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-xl font-semibold mb-6">Step 2: Select Contract Types</h2>
                <p class="text-gray-600 mb-6">Choose the type of contracts to download:</p>

                <div class="space-y-4">
                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                        <input type="radio" id="options" name="contract_type" value="options" class="mr-4">
                        <label for="options" class="cursor-pointer flex-1">
                            <div class="font-medium text-gray-900">Options Only</div>
                            <div class="text-sm text-gray-600">Call and Put options for all strikes</div>
                        </label>
                    </div>

                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                        <input type="radio" id="futures" name="contract_type" value="futures" class="mr-4">
                        <label for="futures" class="cursor-pointer flex-1">
                            <div class="font-medium text-gray-900">Futures Only</div>
                            <div class="text-sm text-gray-600">Futures contracts</div>
                        </label>
                    </div>

                    <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                        <input type="radio" id="both" name="contract_type" value="both" class="mr-4" checked>
                        <label for="both" class="cursor-pointer flex-1">
                            <div class="font-medium text-gray-900">Both Options & Futures</div>
                            <div class="text-sm text-gray-600">All available contracts (recommended)</div>
                        </label>
                    </div>
                </div>

                <!-- Strike Range Filter (visible when options or both selected) -->
                <div id="strike-filter-section" class="mt-6 border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Strike Range Filter</h3>
                    <p class="text-sm text-gray-600 mb-4">Optionally limit which option strikes are collected:</p>

                    <div class="space-y-3">
                        <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                            <input type="radio" name="strike_filter_type" value="all" class="mr-3" checked onchange="updateStrikeFilterUI()">
                            <div>
                                <div class="font-medium text-gray-900 text-sm">All Strikes</div>
                                <div class="text-xs text-gray-500">Download data for every available strike price (default)</div>
                            </div>
                        </label>

                        <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                            <input type="radio" name="strike_filter_type" value="atm_range" class="mr-3" onchange="updateStrikeFilterUI()">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 text-sm">ATM +/- N Strikes</div>
                                <div class="text-xs text-gray-500">Strikes around the at-the-money price</div>
                            </div>
                        </label>

                        <div id="atm-range-input" class="hidden ml-8 mt-2 mb-2">
                            <label class="text-sm text-gray-700">Number of strikes around ATM:</label>
                            <input type="number" id="atm-range-value" min="1" max="50" value="10"
                                   class="ml-2 w-20 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500">
                        </div>

                        <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:border-green-300 cursor-pointer">
                            <input type="radio" name="strike_filter_type" value="custom" class="mr-3" onchange="updateStrikeFilterUI()">
                            <div>
                                <div class="font-medium text-gray-900 text-sm">Custom Range</div>
                                <div class="text-xs text-gray-500">Specify min and max strike prices</div>
                            </div>
                        </label>

                        <div id="custom-range-input" class="hidden ml-8 mt-2 mb-2 flex items-center gap-3">
                            <div>
                                <label class="text-sm text-gray-700">Min Strike:</label>
                                <input type="number" id="custom-min-strike" min="0" step="0.5"
                                       class="ml-1 w-28 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                       placeholder="e.g. 20000">
                            </div>
                            <div>
                                <label class="text-sm text-gray-700">Max Strike:</label>
                                <input type="number" id="custom-max-strike" min="0" step="0.5"
                                       class="ml-1 w-28 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                       placeholder="e.g. 25000">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg" onclick="prevStep(2)">
                        Previous
                    </button>
                    <button type="button" class="btn-supabase" onclick="nextStep(2)">
                        Next Step
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Expiry Dates -->
    <div id="step3" class="step-content hidden">
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-xl font-semibold mb-6">Step 3: Select Expiry Dates</h2>
                <p class="text-gray-600 mb-6">Choose which expiry dates to collect data for:</p>

                <div id="expiry-container" class="space-y-6">
                    <!-- Expiry dates will be loaded here -->
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg" onclick="prevStep(3)">
                        Previous
                    </button>
                    <button type="button" class="btn-supabase" onclick="nextStep(3)" id="next3" disabled>
                        Next Step
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Configure & Download -->
    <div id="step4" class="step-content hidden">
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-xl font-semibold mb-6">Step 4: Configure & Download</h2>

                <!-- Summary -->
                <div class="card-minimal p-4 mb-6 border-blue-200 bg-blue-50">
                    <h3 class="font-semibold text-blue-800 mb-2">Summary</h3>
                    <div id="collection-summary" class="text-sm text-blue-700">
                        <!-- Summary will be populated -->
                    </div>
                    <!-- Estimation -->
                    <div id="collection-estimation" class="mt-3 pt-3 border-t border-blue-200 hidden">
                        <h4 class="font-semibold text-blue-800 mb-2">Estimated Work</h4>
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div>
                                <div id="est-api-calls" class="text-lg font-bold text-blue-800">-</div>
                                <div class="text-xs text-blue-600">API Calls</div>
                            </div>
                            <div>
                                <div id="est-time" class="text-lg font-bold text-blue-800">-</div>
                                <div class="text-xs text-blue-600">Est. Time</div>
                            </div>
                            <div>
                                <div id="est-storage" class="text-lg font-bold text-blue-800">-</div>
                                <div class="text-xs text-blue-600">Est. Storage</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Interval</label>
                        <select id="interval" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <option value="1minute">1 Minute (Recommended)</option>
                            <option value="5minute">5 Minutes</option>
                            <option value="15minute">15 Minutes</option>
                            <option value="30minute">30 Minutes</option>
                            <option value="1hour">1 Hour</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Concurrent Workers</label>
                        <input type="range" id="workers" min="1" max="50" value="10"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1 (Safe)</span>
                            <span id="workers-value">10 (Recommended)</span>
                            <span>50 (Fast)</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Instruments fetched concurrently. Rate limiter auto-throttles to stay within Upstox limits (45 req/sec).</p>
                    </div>

                    <div class="flex items-start gap-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                        <input type="checkbox" id="force-refetch" class="mt-1 checkbox checkbox-sm checkbox-warning">
                        <div>
                            <label for="force-refetch" class="text-sm font-medium text-amber-800 cursor-pointer">Force Re-download</label>
                            <p class="text-xs text-amber-600 mt-0.5">Re-download candle data even for contracts that were previously fetched. Use this if data was lost or corrupted.</p>
                        </div>
                    </div>
                </div>

                <!-- Inline Progress Section -->
                <div id="inline-progress" class="hidden mt-8">
                    <div class="card-minimal p-6 border-green-200 bg-green-50">
                        <h3 class="text-xl font-semibold mb-6 text-green-800">Data Collection in Progress</h3>

                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                            <div id="progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="text-center">
                                <div id="stat-expiries" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Expiries</div>
                            </div>
                            <div class="text-center">
                                <div id="stat-contracts" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Contracts</div>
                            </div>
                            <div class="text-center">
                                <div id="stat-candles" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Candles</div>
                            </div>
                            <div class="text-center">
                                <div id="stat-errors" class="text-2xl font-bold text-red-600">0</div>
                                <div class="text-sm text-gray-600">Errors</div>
                            </div>
                        </div>

                        <!-- Per-Instrument Progress -->
                        <div id="instrument-progress-section" class="mb-4 hidden">
                            <div class="text-sm text-gray-600 mb-2">Per-Instrument Progress:</div>
                            <div id="instrument-progress-bars" class="space-y-2"></div>
                        </div>

                        <!-- Current Action -->
                        <div class="mb-4">
                            <div class="text-sm text-gray-600 mb-1">Current Action:</div>
                            <div id="current-action" class="font-medium text-gray-800">Initializing...</div>
                        </div>

                        <!-- Completion Actions -->
                        <div id="completion-actions" class="hidden mt-4 text-center">
                            <button onclick="window.location.href='{{ url_for('status.status_page') }}'" class="btn-supabase mr-4">
                                View Status
                            </button>
                            <button onclick="startNewCollection()" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg">
                                Start New Collection
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" id="prev-button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg" onclick="prevStep(4)">
                        Previous
                    </button>
                    <button type="button" id="start-button" class="btn-supabase text-lg px-8 py-3" onclick="startCollection()">
                        Start Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="card-minimal max-w-2xl w-full mx-4">
            <div class="p-8">
                <h3 class="text-xl font-semibold mb-6">Data Collection in Progress</h3>

                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                    <div id="progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="stat-expiries">0</div>
                        <div class="text-xs text-gray-600">Expiries</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="stat-contracts">0</div>
                        <div class="text-xs text-gray-600">Contracts</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="stat-candles">0</div>
                        <div class="text-xs text-gray-600">Candles</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="stat-errors">0</div>
                        <div class="text-xs text-gray-600">Errors</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// XSS escaping helpers
function escHtml(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// Wizard State
let currentStep = 1;
let selectedInstruments = [];
let selectedContractType = 'both';
let selectedExpiries = {};
let taskId = null;
let progressInterval = null;

// Strike filter UI toggle
function updateStrikeFilterUI() {
    const filterType = document.querySelector('input[name="strike_filter_type"]:checked').value;
    document.getElementById('atm-range-input').classList.toggle('hidden', filterType !== 'atm_range');
    document.getElementById('custom-range-input').classList.toggle('hidden', filterType !== 'custom');

    // Show/hide entire strike filter section based on contract type
    const contractType = document.querySelector('input[name="contract_type"]:checked').value;
    const section = document.getElementById('strike-filter-section');
    if (contractType === 'futures') {
        section.classList.add('hidden');
    } else {
        section.classList.remove('hidden');
    }
}

// Listen for contract type changes to show/hide strike filter
document.addEventListener('change', function(e) {
    if (e.target.name === 'contract_type') {
        updateStrikeFilterUI();
    }
});

function getStrikeFilter() {
    const filterType = document.querySelector('input[name="strike_filter_type"]:checked').value;
    if (filterType === 'all') return null;
    if (filterType === 'atm_range') {
        const range = parseInt(document.getElementById('atm-range-value').value) || 10;
        return { type: 'atm_range', atm_range: range };
    }
    if (filterType === 'custom') {
        const minStr = document.getElementById('custom-min-strike').value;
        const maxStr = document.getElementById('custom-max-strike').value;
        const filter = { type: 'custom' };
        if (minStr) filter.min_strike = parseFloat(minStr);
        if (maxStr) filter.max_strike = parseFloat(maxStr);
        return filter;
    }
    return null;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadInstrumentsForWizard();
    setupWorkerSlider();
});

// Load instruments from API (#9) â€” grouped by category
let allWizardInstruments = [];

async function loadInstrumentsForWizard() {
    try {
        const res = await fetch('/api/instruments');
        const data = await res.json();
        const container = document.getElementById('instruments-container');
        allWizardInstruments = (data.instruments || []).filter(i => i.is_active);
        if (allWizardInstruments.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 py-4">No active instruments. Add some in Settings.</div>';
            return;
        }
        renderGroupedInstruments(allWizardInstruments);
        updateInstrumentSelection();
    } catch (e) {
        document.getElementById('instruments-container').innerHTML =
            '<div class="text-red-500 text-center py-4">Failed to load instruments</div>';
    }
}

// Sanitize category name for use as CSS class suffix
function catSlug(cat) {
    return cat.replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-');
}

function renderGroupedInstruments(instruments) {
    const container = document.getElementById('instruments-container');
    // Group by category
    const grouped = {};
    instruments.forEach(inst => {
        const cat = inst.category || 'Index';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(inst);
    });

    const categoryConfig = {
        'Index': { color: 'green', icon: '&#x1F4C8;', expanded: true },
        'Stock F&O': { color: 'blue', icon: '&#x1F3E2;', expanded: false },
        'Commodity': { color: 'amber', icon: '&#x26CF;', expanded: false },
        'BSE F&O': { color: 'purple', icon: '&#x1F3ED;', expanded: false },
    };

    // Sort: Index first, then Stock F&O, Commodity, etc
    const order = ['Index', 'Stock F&O', 'Commodity', 'BSE F&O'];
    const sortedCats = Object.keys(grouped).sort((a, b) => {
        const ia = order.indexOf(a), ib = order.indexOf(b);
        return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
    });

    container.innerHTML = sortedCats.map(cat => {
        const cfg = categoryConfig[cat] || { color: 'gray', icon: '', expanded: false };
        const slug = catSlug(cat);
        const insts = grouped[cat];
        const isExpanded = cfg.expanded || insts.length <= 10;
        return `
            <div class="border border-gray-200 rounded-lg overflow-hidden" data-category="${slug}">
                <div class="flex items-center justify-between p-3 bg-${cfg.color}-50 cursor-pointer select-none"
                     onclick="toggleCategory('${slug}')">
                    <div class="flex items-center gap-2">
                        <span class="text-sm">${cfg.icon}</span>
                        <span class="font-semibold text-${cfg.color}-700 text-sm">${cat}</span>
                        <span class="text-xs text-${cfg.color}-500">(${insts.length})</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" class="text-xs text-${cfg.color}-600 hover:underline"
                                onclick="event.stopPropagation(); selectCategory('${slug}')">Select All</button>
                        <svg class="w-4 h-4 text-gray-500 transition-transform category-arrow-${slug}"
                             style="${isExpanded ? 'transform:rotate(180deg)' : ''}"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                </div>
                <div class="category-body-${slug} ${isExpanded ? '' : 'hidden'}">
                    <div class="p-2 grid grid-cols-1 md:grid-cols-2 gap-1 max-h-64 overflow-y-auto">
                        ${insts.map((inst, idx) => {
                            const globalIdx = instruments.indexOf(inst);
                            return `
                            <div class="flex items-center p-2 border border-gray-100 rounded hover:border-${cfg.color}-300 cursor-pointer instrument-item"
                                 data-symbol="${escAttr(inst.symbol.toLowerCase())}">
                                <input type="checkbox" id="inst_${globalIdx}" name="instruments"
                                       value="${escAttr(inst.instrument_key)}" class="mr-2"
                                       data-category="${escAttr(slug)}">
                                <label for="inst_${globalIdx}" class="cursor-pointer flex-1 text-sm">
                                    <span class="font-medium text-gray-900">${escHtml(inst.symbol)}</span>
                                </label>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleCategory(cat) {
    const cls = 'category-body-' + catSlug(cat);
    const arrowCls = 'category-arrow-' + catSlug(cat);
    document.querySelectorAll('.' + cls).forEach(el => el.classList.toggle('hidden'));
    document.querySelectorAll('.' + arrowCls).forEach(el => {
        el.style.transform = el.style.transform === 'rotate(180deg)' ? '' : 'rotate(180deg)';
    });
}

function selectCategory(slug) {
    const checkboxes = document.querySelectorAll(`input[data-category="${slug}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateInstrumentSelection();
}

function filterInstruments() {
    const query = document.getElementById('instrument-search').value.toLowerCase().trim();
    document.querySelectorAll('.instrument-item').forEach(el => {
        const symbol = el.getAttribute('data-symbol') || '';
        el.style.display = (!query || symbol.includes(query)) ? '' : 'none';
    });
}

function deselectAll() {
    document.querySelectorAll('input[name="instruments"]').forEach(cb => cb.checked = false);
    updateInstrumentSelection();
}

// Step Navigation
function nextStep(step) {
    if (step === 1 && selectedInstruments.length === 0) {
        showToast('Please select at least one instrument', 'warning');
        return;
    }

    if (step === 3 && Object.keys(selectedExpiries).length === 0) {
        showToast('Please select at least one expiry date', 'warning');
        return;
    }

    if (step === 2) {
        loadExpiries();
    } else if (step === 3) {
        showSummary();
    }

    hideStep(currentStep);
    currentStep = step + 1;
    showStep(currentStep);
    updateStepIndicator();
}

function prevStep(step) {
    hideStep(currentStep);
    currentStep = step - 1;
    showStep(currentStep);
    updateStepIndicator();
}

function showStep(step) {
    document.getElementById(`step${step}`).classList.remove('hidden');
}

function hideStep(step) {
    document.getElementById(`step${step}`).classList.add('hidden');
}

function updateStepIndicator() {
    // Update progress indicators
    for (let i = 1; i <= 4; i++) {
        const circle = document.querySelector(`.step-content:nth-child(${i + 2}) .w-8.h-8`);
        if (i <= currentStep) {
            circle?.classList.add('bg-green-500', 'text-white');
            circle?.classList.remove('bg-gray-300', 'text-gray-600');
        }
    }
}

// Instrument Selection
function selectAll() {
    const checkboxes = document.querySelectorAll('input[name="instruments"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });

    updateInstrumentSelection();
}

function updateInstrumentSelection() {
    const checkboxes = document.querySelectorAll('input[name="instruments"]:checked');
    selectedInstruments = Array.from(checkboxes).map(cb => cb.value);

    const nextBtn = document.getElementById('next1');
    nextBtn.disabled = selectedInstruments.length === 0;
    nextBtn.classList.toggle('opacity-50', selectedInstruments.length === 0);

    const countEl = document.getElementById('selection-count');
    if (countEl) {
        countEl.textContent = selectedInstruments.length > 0
            ? `${selectedInstruments.length} selected`
            : '';
    }
}

// Load Expiries
async function loadExpiries() {
    const container = document.getElementById('expiry-container');
    container.innerHTML = '<div class="text-center text-gray-500">Loading expiries...</div>';

    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
        const response = await fetch('/api/instruments/expiries', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ instruments: selectedInstruments })
        });

        const data = await response.json();

        // Show errors from API (e.g. invalid token)
        if (data.errors && data.errors.length > 0) {
            const errorHtml = data.errors.map(e =>
                '<div class="flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm mb-3">' +
                '<svg class="w-5 h-5 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd"/></svg>' +
                '<span>' + escHtml(e) + '</span></div>'
            ).join('');
            container.innerHTML = errorHtml;
            // Still display any instruments that did return data
            const hasData = Object.values(data.expiries || {}).some(d => d.length > 0);
            if (hasData) {
                displayExpiries(data.expiries);
            }
            return;
        }

        displayExpiries(data.expiries);
    } catch (error) {
        container.innerHTML = '<div class="text-center text-red-500">Error loading expiries: ' + escHtml(error.message) + '</div>';
    }
}

function displayExpiries(expiries) {
    const container = document.getElementById('expiry-container');
    container.innerHTML = '';

    Object.entries(expiries).forEach(([instrument, dates]) => {
        const instrumentDiv = document.createElement('div');
        instrumentDiv.className = 'border border-gray-200 rounded-lg p-4';

        // Look up display name from loaded instruments, fallback to key suffix
        const matched = allWizardInstruments.find(i => i.instrument_key === instrument);
        const instrumentName = matched ? matched.symbol : (instrument.split('|')[1] || instrument);

        instrumentDiv.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <h4 class="font-medium text-gray-900">${instrumentName}</h4>
                <button type="button" class="text-sm text-green-600 hover:text-green-700" onclick="selectAllExpiries('${instrument}')">
                    Select All (${dates.length})
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                ${dates.map(date => `
                    <label class="flex items-center p-2 border border-gray-200 rounded cursor-pointer hover:border-green-300">
                        <input type="checkbox" name="expiry_${instrument}" value="${date}" class="mr-2" onchange="updateExpirySelection()">
                        <span class="text-sm">${formatDate(date)}</span>
                    </label>
                `).join('')}
            </div>
        `;

        container.appendChild(instrumentDiv);
    });
}

function selectAllExpiries(instrument) {
    const checkboxes = document.querySelectorAll(`input[name="expiry_${instrument}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });

    updateExpirySelection();
}

function updateExpirySelection() {
    selectedExpiries = {};

    selectedInstruments.forEach(instrument => {
        const checkboxes = document.querySelectorAll(`input[name="expiry_${instrument}"]:checked`);
        const dates = Array.from(checkboxes).map(cb => cb.value);
        if (dates.length > 0) {
            selectedExpiries[instrument] = dates;
        }
    });

    const nextBtn = document.getElementById('next3');
    nextBtn.disabled = Object.keys(selectedExpiries).length === 0;
    nextBtn.classList.toggle('opacity-50', Object.keys(selectedExpiries).length === 0);
}

// Show Summary
function showSummary() {
    selectedContractType = document.querySelector('input[name="contract_type"]:checked').value;

    const strikeFilterSummary = getStrikeFilter();
    let strikeDesc = 'All Strikes';
    if (strikeFilterSummary) {
        if (strikeFilterSummary.type === 'atm_range') {
            strikeDesc = `ATM +/- ${strikeFilterSummary.atm_range} strikes`;
        } else if (strikeFilterSummary.type === 'custom') {
            const parts = [];
            if (strikeFilterSummary.min_strike != null) parts.push(`Min: ${strikeFilterSummary.min_strike}`);
            if (strikeFilterSummary.max_strike != null) parts.push(`Max: ${strikeFilterSummary.max_strike}`);
            strikeDesc = `Custom Range (${parts.join(', ')})`;
        }
    }

    let summary = `
        <p><strong>Instruments:</strong> ${selectedInstruments.map(i => {
            const m = allWizardInstruments.find(inst => inst.instrument_key === i);
            return m ? m.symbol : (i.split('|')[1] || i);
        }).join(', ')}</p>
        <p><strong>Contract Type:</strong> ${selectedContractType}</p>
        <p><strong>Strike Filter:</strong> ${strikeDesc}</p>
        <p><strong>Expiries:</strong> ${Object.values(selectedExpiries).flat().length} selected</p>
    `;

    document.getElementById('collection-summary').innerHTML = summary;

    // Fetch estimation
    fetchEstimation();
}

async function fetchEstimation() {
    const estDiv = document.getElementById('collection-estimation');
    try {
        const res = await fetch('/api/collect/estimate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                instruments: selectedInstruments,
                expiries: selectedExpiries,
                contract_type: selectedContractType
            })
        });
        const est = await res.json();
        document.getElementById('est-api-calls').textContent = (est.api_calls || 0).toLocaleString();
        document.getElementById('est-time').textContent = est.est_time_display || '-';
        document.getElementById('est-storage').textContent = est.est_storage_display || '-';
        estDiv.classList.remove('hidden');
    } catch (e) {
        estDiv.classList.add('hidden');
    }
}

// Worker Slider
function setupWorkerSlider() {
    const slider = document.getElementById('workers');
    const valueSpan = document.getElementById('workers-value');

    slider.addEventListener('input', function() {
        const value = parseInt(this.value);
        let description;

        if (value === 1) description = `${value} (Safe)`;
        else if (value <= 10) description = `${value} (Recommended)`;
        else if (value <= 25) description = `${value} (Fast)`;
        else if (value <= 40) description = `${value} (Aggressive)`;
        else description = `${value} (Max throughput)`;

        valueSpan.textContent = description;
    });
}

// Start Collection
async function startCollection() {
    // Check token status before starting (#7)
    try {
        const tokenRes = await fetch('/api/auth/token-status');
        const tokenData = await tokenRes.json();
        if (tokenData.valid && tokenData.remaining_seconds < 3600) {
            var mins = Math.floor(tokenData.remaining_seconds / 60);
            if (!confirm(`Token expires in ${mins} minutes. Collection may fail if token expires mid-way. Continue anyway?`)) return;
        }
    } catch (e) { /* ignore check failure, proceed */ }

    const interval = document.getElementById('interval').value;
    const workers = parseInt(document.getElementById('workers').value);

    const strikeFilter = getStrikeFilter();
    const forceRefetch = document.getElementById('force-refetch')?.checked || false;
    const config = {
        instruments: selectedInstruments,
        contract_type: selectedContractType,
        expiries: selectedExpiries,
        interval: interval,
        workers: workers,
        strike_filter: strikeFilter,
        force_refetch: forceRefetch
    };

    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
        const response = await fetch('/api/collect/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(config)
        });

        const data = await response.json();

        if (data.success) {
            taskId = data.task_id;
            showInlineProgress();
            startProgressTracking();
        } else {
            showToast('Failed to start collection: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error starting collection: ' + error.message, 'error');
    }
}

// Progress Tracking
function showInlineProgress() {
    // Hide the start button and show the inline progress
    document.getElementById('start-button').style.display = 'none';
    document.getElementById('prev-button').style.display = 'none';
    document.getElementById('inline-progress').classList.remove('hidden');
}

function startProgressTracking() {
    // SSE-driven: when we get a task event for our taskId, trigger a fetch
    if (window._sseSource) {
        function onSSE(e) {
            try {
                var d = JSON.parse(e.data);
                if (d.task_id === taskId) updateProgress();
            } catch(err) {}
        }
        window._sseSource.addEventListener('task:update', onSSE);
        window._sseSource.addEventListener('task:completed', onSSE);
        window._sseSource.addEventListener('task:failed', onSSE);
    }
    // Always keep a polling fallback (slower interval when SSE is active)
    progressInterval = setInterval(updateProgress, window._sseSource ? 5000 : 1000);
}

async function updateProgress() {
    if (!taskId) return;

    try {
        const response = await fetch(`/api/collect/status/${taskId}`);
        const data = await response.json();

        // Handle task not found (404) - server was likely restarted
        if (response.status === 404 || data.error) {
            clearInterval(progressInterval);
            document.getElementById('current-action').textContent = 'Task not found - server may have restarted. Please start a new collection.';
            document.getElementById('current-action').className = 'font-medium text-orange-600';
            document.getElementById('completion-actions').classList.remove('hidden');
            return;
        }

        if (data.task_id || data.status) {
            const task = data;

            // Update progress bar
            document.getElementById('progress-bar').style.width = `${task.progress}%`;

            // Update stats
            document.getElementById('stat-expiries').textContent = task.stats.expiries || 0;
            document.getElementById('stat-contracts').textContent = task.stats.contracts || 0;
            document.getElementById('stat-candles').textContent = task.stats.candles || 0;
            document.getElementById('stat-errors').textContent = task.stats.errors || 0;

            // Update current action (replace instrument keys with display names)
            if (task.current_action) {
                let actionText = task.current_action;
                allWizardInstruments.forEach(inst => {
                    if (actionText.includes(inst.instrument_key)) {
                        actionText = actionText.replace(inst.instrument_key, inst.symbol);
                    }
                });
                document.getElementById('current-action').textContent = actionText;
            }

            // Render per-instrument progress
            if (task.instrument_progress && Object.keys(task.instrument_progress).length > 0) {
                const section = document.getElementById('instrument-progress-section');
                section.classList.remove('hidden');
                const container = document.getElementById('instrument-progress-bars');
                container.innerHTML = Object.entries(task.instrument_progress).map(([name, ip]) => {
                    const mi = allWizardInstruments.find(inst => inst.instrument_key === name);
                    const label = mi ? mi.symbol : (name.split('|')[1] || name);
                    const statusColor = ip.status === 'completed' ? 'green' :
                                        ip.status === 'failed' ? 'red' :
                                        ip.status === 'running' ? 'blue' : 'gray';
                    return `
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-medium w-28 truncate">${label}</span>
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div class="bg-${statusColor}-500 h-2 rounded-full transition-all duration-300" style="width:${ip.progress || 0}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 w-24 text-right">${ip.expiries_done || 0}/${ip.expiries_total || 0} expiries</span>
                        </div>
                    `;
                }).join('');
            }

            // Check if completed
            if (task.status === 'completed' || task.status === 'failed') {
                clearInterval(progressInterval);
                document.getElementById('completion-actions').classList.remove('hidden');

                if (task.status === 'completed') {
                    document.getElementById('current-action').textContent = 'Collection completed successfully!';
                    document.getElementById('current-action').className = 'font-medium text-green-600';
                } else {
                    document.getElementById('current-action').textContent = `Collection failed: ${task.error_message}`;
                    document.getElementById('current-action').className = 'font-medium text-red-600';
                }
            }
        }
    } catch (error) {
        console.error('Error updating progress:', error);
    }
}

// Log functions removed - not needed

function startNewCollection() {
    // Hide inline progress
    document.getElementById('inline-progress').classList.add('hidden');

    // Show buttons again
    document.getElementById('start-button').style.display = '';
    document.getElementById('prev-button').style.display = '';

    // Reset form to step 1
    showStep(1);

    // Clear all form data
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

    // Reset contract type to default (both)
    document.getElementById('both').checked = true;

    // Reset interval to default
    document.getElementById('interval').value = '1minute';

    // Reset workers to default
    document.getElementById('workers').value = '10';

    // Reset UI
    document.getElementById('step-2-content').innerHTML = '';
    document.getElementById('step-3-content').innerHTML = '';
    updateButtonStates();

    if (progressInterval) {
        clearInterval(progressInterval);
    }
}

function goToStatus() {
    window.location.href = '{{ url_for("status.status_page") }}';
}

// Utility Functions
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: '2-digit'
    });
}

// Event Listeners
document.addEventListener('change', function(e) {
    if (e.target.name === 'instruments') {
        updateInstrumentSelection();
    }
});
</script>
{% endblock %}