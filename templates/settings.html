{% extends "base.html" %}

{% block title %}Settings - ExpiryTrack{% endblock %}

{% block content %}
    <div class="max-w-2xl mx-auto space-y-6">
        <!-- Plus Plan Requirement Warning -->
        <div class="card-minimal p-6 border-amber-200 bg-amber-50">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-6 h-6 bg-amber-500 text-white rounded-full flex items-center justify-center text-sm font-bold">!</div>
                </div>
                <div>
                    <h3 class="font-semibold text-amber-800 mb-2">Upstox Plus Plan Required</h3>
                    <p class="text-amber-700 text-sm mb-3">
                        ExpiryTrack requires the <strong>Upstox Plus Plan</strong> to access expired contract data.
                        The Basic Plan does not provide access to historical data for expired derivatives.
                    </p>
                    <div class="text-xs text-amber-600">
                        <p>* Currently free to activate (may become chargeable with advance notice)</p>
                        <p>* Can switch between plans anytime (24-hour cooling period)</p>
                        <p>* Activate in your Upstox account: Settings > Plans</p>
                    </div>
                    <a href="https://upstox.com/files/terms-and-condition/plus-pack.pdf"
                       target="_blank"
                       class="inline-block mt-2 text-amber-800 underline text-sm hover:text-amber-900">
                        View Plus Plan Terms
                    </a>
                </div>
            </div>
        </div>

        <!-- API Configuration -->
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-2xl font-semibold mb-6">API Configuration</h2>

                <div class="card-minimal p-4 mb-6 border-blue-200 bg-blue-50">
                    <h3 class="font-semibold text-blue-800 mb-2">How to get API credentials:</h3>
                    <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                        <li>Go to <a href="https://upstox.com/developer/apps" target="_blank" class="underline hover:text-blue-900">Upstox Developer Console</a></li>
                        <li>Create a new app or select existing one</li>
                        <li>Copy the API Key and API Secret</li>
                        <li>Set Redirect URL as: <code class="bg-blue-100 px-2 py-1 rounded">http://127.0.0.1:5000/upstox/callback</code></li>
                    </ol>
                </div>

                <form action="/save_credentials" method="POST" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            API Key (Client ID)
                        </label>
                        <input type="text" name="api_key" placeholder="Enter your API Key"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                               value="{{ credential.api_key if credential else '' }}" required />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            API Secret
                        </label>
                        <input type="password" name="api_secret" placeholder="Enter your API Secret"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                               value="{{ credential.api_secret if credential else '' }}" required />
                        <p class="text-xs text-gray-500 mt-1">Keep this secret and never share it!</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Redirect URL
                        </label>
                        <input type="text" name="redirect_url" placeholder="Redirect URL"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                               value="{{ credential.redirect_url if credential else 'http://127.0.0.1:5000/upstox/callback' }}" required />
                        <p class="text-xs text-gray-500 mt-1">Add this exact URL to your Upstox app settings</p>
                    </div>

                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-4">Rate Limits</h3>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-gray-800">50</div>
                                <div class="text-xs text-gray-600">requests/sec</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-gray-800">500</div>
                                <div class="text-xs text-gray-600">requests/min</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-gray-800">2000</div>
                                <div class="text-xs text-gray-600">requests/30min</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 justify-end pt-6">
                        <button type="submit" class="btn-supabase">Save Settings</button>
                        {% if credential %}
                        <a href="/login" class="btn bg-green-100 text-green-700 hover:bg-green-200 font-medium py-2 px-4 rounded-lg">Login with Upstox</a>
                        {% endif %}
                    </div>
                </form>

                {% if credential %}
                <div class="mt-6 pt-6 border-t">
                    <div class="card-minimal p-4 border-green-200 bg-green-50">
                        <span class="text-green-800 font-medium">API credentials configured. You can now login with Upstox!</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Instruments Management (#9) -->
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-2xl font-semibold mb-4">Instruments</h2>
                <p class="text-sm text-gray-500 mb-4">Manage instruments available for data collection.</p>

                <div id="instruments-list" class="space-y-2 mb-4"
                     hx-get="/partials/instruments/list"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <div class="text-center text-gray-400 py-4">Loading...</div>
                </div>

                <!-- Import F&O Instruments -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Import F&O Instruments</h4>
                    <p class="text-xs text-gray-500 mb-3">Auto-import F&O-eligible instruments from Instrument Master. Sync master first from the Instruments page.</p>
                    <div id="fo-import-status" class="hidden mb-3 p-3 rounded-lg text-sm"></div>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <button onclick="importFO('stock')" class="btn bg-blue-50 text-blue-700 hover:bg-blue-100 font-medium py-2 px-3 rounded-lg text-sm" id="btn-import-stock">
                            NSE F&O Stocks
                        </button>
                        <button onclick="importFO('commodity')" class="btn bg-amber-50 text-amber-700 hover:bg-amber-100 font-medium py-2 px-3 rounded-lg text-sm" id="btn-import-commodity">
                            MCX Commodities
                        </button>
                        <button onclick="importFO(null)" class="btn bg-green-50 text-green-700 hover:bg-green-100 font-medium py-2 px-3 rounded-lg text-sm" id="btn-import-all">
                            Import All F&O
                        </button>
                    </div>
                    <div id="fo-available-counts" class="text-xs text-gray-400"></div>
                </div>

                <!-- Search & Add from Master -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Search & Add from Instrument Master</h4>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="master-search" placeholder="Search by name or symbol..."
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                               onkeyup="debounceSearch()" />
                    </div>
                    <div id="master-search-results" class="max-h-48 overflow-y-auto space-y-1"></div>
                </div>

                <!-- Manual Add -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Add Manually</h4>
                    <div class="flex gap-2">
                        <input type="text" id="new-inst-key" placeholder="e.g. NSE_INDEX|Nifty 50"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500" />
                        <input type="text" id="new-inst-symbol" placeholder="Display name"
                               class="w-36 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500" />
                        <button onclick="addInstrument()" class="btn-supabase text-sm">Add</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Keys (#10) -->
        {% if is_authenticated %}
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-2xl font-semibold mb-4">API Keys</h2>
                <p class="text-sm text-gray-500 mb-4">Generate API keys for external access to your data via the REST API.</p>

                <div id="api-keys-list" class="space-y-2 mb-4">
                    <div class="text-center text-gray-400 py-4">Loading...</div>
                </div>

                <div class="border-t pt-4 mt-4">
                    <div class="flex gap-2">
                        <input type="text" id="new-key-name" placeholder="Key name (e.g. My Script)"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500" />
                        <button onclick="generateApiKey()" class="btn-supabase text-sm">Generate Key</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup & Restore (#11) -->
        <div class="card-minimal">
            <div class="p-8">
                <h2 class="text-2xl font-semibold mb-4">Backup & Restore</h2>
                <p class="text-sm text-gray-500 mb-4">Create database backups and restore from previous snapshots.</p>

                <div class="flex gap-3 mb-4">
                    <button onclick="createBackup()" class="btn-supabase text-sm" id="btn-create-backup">Create Backup</button>
                    <label class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg text-sm cursor-pointer">
                        Restore from File
                        <input type="file" accept=".zip" onchange="restoreBackup(this)" class="hidden" />
                    </label>
                </div>

                <div id="backups-list" class="space-y-2">
                    <div class="text-center text-gray-400 py-4">Loading...</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
<script>
// ── Instruments (#9) ─────────────────────────────────────
async function loadInstruments() {
    try {
        const res = await fetch('/api/instruments');
        const data = await res.json();
        const list = document.getElementById('instruments-list');
        if (!data.instruments || data.instruments.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-4">No instruments configured</div>';
            return;
        }
        // Group by category
        const grouped = {};
        data.instruments.forEach(inst => {
            const cat = inst.category || 'Index';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(inst);
        });

        const categoryColors = {
            'Index': 'green', 'Stock F&O': 'blue', 'Commodity': 'amber', 'BSE F&O': 'purple'
        };

        list.innerHTML = Object.entries(grouped).map(([cat, instruments]) => {
            const color = categoryColors[cat] || 'gray';
            return `
                <div class="mb-3">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-semibold text-${color}-600 uppercase tracking-wider">${escHtml(cat)} (${instruments.length})</span>
                    </div>
                    ${instruments.map(inst => `
                        <div class="flex items-center justify-between p-2 border border-gray-200 rounded-lg mb-1">
                            <div>
                                <span class="font-medium text-sm">${escHtml(inst.symbol)}</span>
                                <span class="text-xs text-gray-400 ml-1">${escHtml(inst.instrument_key)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="cursor-pointer label">
                                    <input type="checkbox" class="toggle toggle-sm toggle-success"
                                           ${inst.is_active ? 'checked' : ''}
                                           onchange="toggleInstrument(${inst.id}, this.checked)" />
                                </label>
                                <button onclick="removeInstrument(${inst.id})" class="btn btn-ghost btn-xs text-red-500" title="Remove">&times;</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }).join('');
    } catch (e) {
        document.getElementById('instruments-list').innerHTML = '<div class="text-red-500 text-center py-4">Failed to load</div>';
    }
}

async function addInstrument() {
    const key = document.getElementById('new-inst-key').value.trim();
    const symbol = document.getElementById('new-inst-symbol').value.trim();
    if (!key || !symbol) { showToast('Both instrument key and display name are required', 'warning'); return; }
    try {
        const res = await fetch('/api/instruments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ instrument_key: key, symbol: symbol })
        });
        const data = await res.json();
        if (data.success) {
            showToast('Instrument added', 'success');
            document.getElementById('new-inst-key').value = '';
            document.getElementById('new-inst-symbol').value = '';
            loadInstruments();
        } else {
            showToast(data.error || 'Failed to add', 'error');
        }
    } catch (e) { showToast('Error: ' + e.message, 'error'); }
}

async function toggleInstrument(id, active) {
    await fetch(`/api/instruments/${id}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ is_active: active })
    });
}

async function removeInstrument(id) {
    if (!confirm('Remove this instrument?')) return;
    await fetch(`/api/instruments/${id}`, { method: 'DELETE' });
    loadInstruments();
}

// ── API Keys (#10) ───────────────────────────────────────
async function loadApiKeys() {
    try {
        const res = await fetch('/api/api-keys');
        const data = await res.json();
        const list = document.getElementById('api-keys-list');
        if (!list) return;
        if (!data.keys || data.keys.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-4">No API keys generated</div>';
            return;
        }
        list.innerHTML = data.keys.map(k => `
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                <div>
                    <span class="font-medium text-sm">${escHtml(k.key_name)}</span>
                    <code class="text-xs text-gray-500 ml-2 bg-gray-100 px-2 py-0.5 rounded">${escHtml(k.api_key_masked)}</code>
                    <span class="text-xs text-gray-400 ml-2">${k.is_active ? '' : '(revoked)'}</span>
                </div>
                <div>
                    ${k.is_active ? `<button onclick="revokeApiKey(${k.id})" class="btn btn-ghost btn-xs text-red-500">Revoke</button>` : ''}
                </div>
            </div>
        `).join('');
    } catch (e) {}
}

async function generateApiKey() {
    const name = document.getElementById('new-key-name').value.trim() || 'Unnamed Key';
    try {
        const res = await fetch('/api/api-keys', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name })
        });
        const data = await res.json();
        if (data.success && data.key) {
            showToast('API key generated! Copy it now — it won\'t be shown again: ' + data.key.api_key, 'success', 15000);
            document.getElementById('new-key-name').value = '';
            loadApiKeys();
        } else {
            showToast(data.error || 'Failed', 'error');
        }
    } catch (e) { showToast('Error: ' + e.message, 'error'); }
}

async function revokeApiKey(id) {
    if (!confirm('Revoke this API key? This cannot be undone.')) return;
    await fetch(`/api/api-keys/${id}`, { method: 'DELETE' });
    showToast('API key revoked', 'info');
    loadApiKeys();
}

// ── Backup & Restore (#11) ───────────────────────────────
async function loadBackups() {
    try {
        const res = await fetch('/api/backup/list');
        const data = await res.json();
        const list = document.getElementById('backups-list');
        if (!list) return;
        if (!data.backups || data.backups.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-4">No backups found</div>';
            return;
        }
        list.innerHTML = data.backups.map(b => `
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                <div>
                    <span class="font-medium text-sm">${escHtml(b.filename)}</span>
                    <span class="text-xs text-gray-500 ml-2">${b.size_mb} MB</span>
                    <span class="text-xs text-gray-400 ml-2">${b.created_at || ''}</span>
                </div>
                <div class="flex gap-1">
                    <a href="/api/backup/download/${encodeURIComponent(b.filename)}" class="btn btn-ghost btn-xs text-blue-600">Download</a>
                    <button onclick="deleteBackup('${escAttr(b.filename)}')" class="btn btn-ghost btn-xs text-red-500">Delete</button>
                </div>
            </div>
        `).join('');
    } catch (e) {}
}

async function createBackup() {
    const btn = document.getElementById('btn-create-backup');
    btn.disabled = true; btn.textContent = 'Creating...';
    try {
        const res = await fetch('/api/backup/create', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            showToast('Backup created: ' + data.filename, 'success');
            loadBackups();
        } else {
            showToast(data.error || 'Failed', 'error');
        }
    } catch (e) { showToast('Error: ' + e.message, 'error'); }
    btn.disabled = false; btn.textContent = 'Create Backup';
}

async function restoreBackup(input) {
    if (!input.files[0]) return;
    if (!confirm('Restore from this backup? Current data will be backed up first.')) { input.value = ''; return; }
    const form = new FormData();
    form.append('file', input.files[0]);
    try {
        const res = await fetch('/api/backup/restore', { method: 'POST', body: form });
        const data = await res.json();
        if (data.success) {
            showToast('Database restored successfully!', 'success');
            loadBackups();
        } else {
            showToast(data.error || 'Restore failed', 'error');
        }
    } catch (e) { showToast('Error: ' + e.message, 'error'); }
    input.value = '';
}

async function deleteBackup(filename) {
    if (!confirm('Delete this backup?')) return;
    await fetch(`/api/backup/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' });
    showToast('Backup deleted', 'info');
    loadBackups();
}

// ── F&O Import ──────────────────────────────────────────
async function importFO(category) {
    const btnId = category === 'stock' ? 'btn-import-stock' :
                  category === 'commodity' ? 'btn-import-commodity' : 'btn-import-all';
    const btn = document.getElementById(btnId);
    const origText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Importing...';

    const statusEl = document.getElementById('fo-import-status');
    try {
        const res = await fetch('/api/instruments/import-fo', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ category: category })
        });
        const data = await res.json();
        if (data.success) {
            statusEl.className = 'mb-3 p-3 rounded-lg text-sm bg-green-50 text-green-700';
            statusEl.textContent = `Imported ${data.added} instruments (${data.skipped} already existed)`;
            statusEl.classList.remove('hidden');
            loadInstruments();
            loadFOCounts();
        } else {
            statusEl.className = 'mb-3 p-3 rounded-lg text-sm bg-red-50 text-red-700';
            statusEl.textContent = data.error || 'Import failed';
            statusEl.classList.remove('hidden');
        }
    } catch (e) {
        statusEl.className = 'mb-3 p-3 rounded-lg text-sm bg-red-50 text-red-700';
        statusEl.textContent = 'Error: ' + e.message;
        statusEl.classList.remove('hidden');
    }
    btn.disabled = false;
    btn.textContent = origText;
}

async function loadFOCounts() {
    try {
        const [stockRes, comRes] = await Promise.all([
            fetch('/api/instruments/fo-available?category=stock'),
            fetch('/api/instruments/fo-available?category=commodity')
        ]);
        const stockData = await stockRes.json();
        const comData = await comRes.json();
        const el = document.getElementById('fo-available-counts');
        el.textContent = `Available to import: ${stockData.count} NSE F&O stocks, ${comData.count} MCX commodities`;
    } catch (e) {}
}

// ── Search from Master ──────────────────────────────────
let searchTimer;
function debounceSearch() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(searchMaster, 300);
}

async function searchMaster() {
    const query = document.getElementById('master-search').value.trim();
    const container = document.getElementById('master-search-results');
    if (query.length < 2) { container.innerHTML = ''; return; }

    try {
        const res = await fetch(`/api/instruments/master/search?q=${encodeURIComponent(query)}&limit=20`);
        const data = await res.json();
        if (!data.instruments || data.instruments.length === 0) {
            container.innerHTML = '<div class="text-xs text-gray-400 py-2">No results found</div>';
            return;
        }
        container.innerHTML = data.instruments.map(inst => `
            <div class="flex items-center justify-between p-2 border border-gray-100 rounded hover:bg-gray-50">
                <div class="flex-1 min-w-0">
                    <span class="text-sm font-medium">${escHtml(inst.trading_symbol || inst.name)}</span>
                    <span class="text-xs text-gray-400 ml-1">${escHtml(inst.segment)}</span>
                    <div class="text-xs text-gray-500 truncate">${escHtml(inst.instrument_key)}</div>
                </div>
                <button onclick="addFromMaster('${escAttr(inst.instrument_key)}', '${escAttr(inst.trading_symbol || inst.name)}', '${escAttr(inst.segment)}')"
                        class="btn btn-ghost btn-xs text-green-600 ml-2 flex-shrink-0">+ Add</button>
            </div>
        `).join('');
    } catch (e) {
        container.innerHTML = '<div class="text-xs text-red-500 py-2">Search failed</div>';
    }
}

async function addFromMaster(key, symbol, segment) {
    const category = segment.includes('INDEX') ? 'Index' :
                     segment.includes('MCX') ? 'Commodity' :
                     segment.includes('_FO') ? 'Stock F&O' : 'Other';
    try {
        const res = await fetch('/api/instruments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ instrument_key: key, symbol: symbol, category: category })
        });
        const data = await res.json();
        if (data.success) {
            showToast(`Added ${symbol}`, 'success');
            loadInstruments();
        } else {
            showToast(data.error || 'Already exists', 'warning');
        }
    } catch (e) { showToast('Error: ' + e.message, 'error'); }
}

// ── Helpers ──────────────────────────────────────────────
function escHtml(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function escAttr(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Init
document.addEventListener('DOMContentLoaded', function() {
    loadInstruments();
    loadFOCounts();
    if (document.getElementById('api-keys-list')) loadApiKeys();
    if (document.getElementById('backups-list')) loadBackups();
});
</script>
{% endblock %}
